# S7-1200 跑马灯上位机程序

基于 S7-1200 PLC + Modbus TCP 的跑马灯控制系统，使用 Go 语言和 Fyne GUI 框架开发。

## 📋 项目简介

这是一个完整的 PLC 跑马灯控制系统，通过 Socket Modbus TCP 协议与西门子 S7-1200 PLC 通信，实现跑马灯效果控制、状态监控和手动操作功能。

## ✨ 功能特性

### 🔌 PLC 连接管理
- **智能连接**：自动检测 PLC 连接状态
- **参数配置**：支持 IP 地址、端口号、Unit ID 配置
- **连接控制**：提供连接/断开按钮，实时状态显示

### 🎛️ 跑马灯控制
- **三挡速度**：1000ms、500ms、200ms 可切换
- **启停控制**：启动/停止按钮，支持速度循环切换
- **状态显示**：实时显示当前挡位、延时值、输出点

### 📊 实时监控
- **数字输入**：监控 DI 10001-10014 状态
- **数字输出**：监控 DQ 1-14 状态
- **环境数据**：实时读取温度和湿度数据
- **边沿检测**：自动检测按钮按下事件

### 🎮 手动控制
- **输出控制**：停止状态下可手动控制任意输出点
- **安全保护**：运行时自动禁用手动控制
- **状态同步**：手动操作实时写入 PLC

### ⚙️ 配置管理
- **自动保存**：配置自动保存到 `config/config.json`
- **默认配置**：首次运行自动创建默认配置
- **参数持久化**：IP、端口、Unit ID 等参数保存

## 🏗️ 技术架构

### 开发环境
- **语言**：Go 1.24.3
- **GUI 框架**：Fyne v2.6.3
- **通信协议**：Modbus TCP (MBAP + PDU)
- **并发模型**：Goroutine + Channel

### 项目结构
```
S7-1200-OwnDis/
├── main.go           # 程序入口
├── modbus.go         # Modbus TCP 通信实现
├── ui.go             # 用户界面实现
├── config.go         # 配置文件读写
├── marquee.go        # 跑马灯控制逻辑
├── input.go          # 输入状态监控
├── environment.go    # 环境数据读取
├── manual.go         # 手动控制逻辑
├── config/           # 配置文件目录
│   └── config.json   # 配置文件
└── docs/             # 文档目录
    └── 跑马灯上位机程序开发文档.md
```

### 通信协议
- **协议**：Modbus TCP
- **端口**：502 (默认，可配置)
- **地址映射**：符合 ModScan 标准
- **字节序**：大端字节序 (Big Endian)

## 🚀 编译方法

### 环境要求
- Windows 11
- Go 1.24.3 或更高版本
- 支持 CGO (用于 GUI 功能)

### 编译命令

#### 完整编译 (推荐)
```bash
go build -o s7-1200-marquee.exe .
```

#### 禁用 CGO 编译
```bash
set CGO_ENABLED=0 && go build -v -o s7-1200-marquee.exe .
```

#### UPX 压缩 (推荐 - 减小文件大小)
```bash
# 下载并使用 UPX 压缩 (UPX文件可放在任意位置)
powershell -command "Invoke-WebRequest -Uri 'https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip' -OutFile 'upx.zip'; Expand-Archive -Path 'upx.zip' -DestinationPath '.'"
upx-4.2.4-win64\upx.exe --best --lzma s7-1200-marquee.exe

# 或者如果UPX在其他位置，修改路径即可
# C:\path\to\upx.exe --best --lzma s7-1200-marquee.exe
```

## 📖 使用说明

### 启动程序
1. 双击 `s7-1200-marquee.exe` 启动程序
2. 程序会自动创建配置文件 `config/config.json`

### 基本操作
1. **配置连接**：
   - 在左侧输入框中修改 IP 地址、端口号、Unit ID
   - 点击"连接"按钮建立 PLC 连接
   - 如需断开，点击"断开"按钮

2. **控制跑马灯**：
   - 点击"启动"按钮开始跑马灯 (默认1挡)
   - 点击"速度切换"按钮循环切换挡位 (1→2→3→1)
   - 点击"停止"按钮停止跑马灯

3. **查看状态**：
   - 左侧状态栏显示连接状态、运行状态、挡位信息
   - 右侧显示所有输入输出点状态
   - 环境数据区域显示温度和湿度

4. **手动控制**：
   - 停止状态下可以使用复选框手动控制输出点
   - 运行时手动控制自动禁用

### 状态说明
- **连接状态**：未连接 / 连接失败 / 已连接
- **运行状态**：停止 / 运行中
- **当前挡位**：无 / 1 / 2 / 3
- **延时值**：0ms / 1000ms / 500ms / 200ms
- **当前输出点**：Q0.0-Q1.5 地址显示

## 🔧 配置说明

### 默认配置
```json
{
  "ip": "192.168.0.10",
  "port": 502,
  "unitId": 1,
  "speedDelays": [1000, 500, 200],
  "pollIntervalMs": 200,
  "windowSize": [800, 600],
  "windowPosition": [100, 100]
}
```

### 配置参数
- **ip**：PLC IP 地址
- **port**：Modbus TCP 端口 (默认 502)
- **unitId**：设备 ID (默认 1)
- **speedDelays**：三挡速度延时值 (毫秒)
- **pollIntervalMs**：状态轮询间隔 (毫秒)
- **windowSize**：窗口大小 [宽度, 高度]
- **windowPosition**：窗口位置 [X, Y]

## 📊 PLC 地址映射

### 数字输出 (DQ)
- **范围**：Q0.0–Q1.5 (地址 1–14)
- **功能码**：01 (读线圈)、05 (写单线圈)、15 (写多线圈)
- **跑马灯顺序**：Q0.0→Q0.1→...→Q0.7→Q1.0→...→Q1.5

### 数字输入 (DI)
- **范围**：I0.0–I1.5 (地址 10001–10014)
- **功能码**：02 (读离散输入)
- **按钮映射**：I0.0 (启动/速度切换)、I0.1 (停止)

### 输入寄存器 (IW)
- **温度**：IW64 (地址 30033)
- **湿度**：IW66 (地址 30034)
- **功能码**：04 (读输入寄存器)

## 🐛 故障排除

### 连接问题
- 检查 PLC IP 地址和端口号是否正确
- 确认 PLC 已启动且 Modbus TCP 服务正常
- 检查防火墙是否阻止了连接

### 编译问题
- 确保 Go 版本 >= 1.24.3
- 检查网络连接 (编译时需要下载依赖)
- 尝试禁用 CGO: `set CGO_ENABLED=0`

### 运行问题
- 如果显示 "连接失败"，检查 PLC 是否可达
- 如果没有 GUI 窗口，检查是否启用了 CGO
- 如果状态不更新，检查轮询间隔配置

## 📝 开发说明

### 主要文件说明
- **main.go**：程序入口，初始化所有组件
- **modbus.go**：Modbus TCP 协议实现
- **ui.go**：Fyne GUI 界面实现
- **marquee.go**：跑马灯控制逻辑
- **input.go**：输入状态监控和边沿检测
- **environment.go**：温湿度数据读取
- **config.go**：配置管理

### 设计模式
- **MVC 架构**：Model-View-Controller 分离
- **观察者模式**：状态变化自动更新 UI
- **生产者-消费者**：Goroutine 间通信
- **单例模式**：配置管理器单例

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件