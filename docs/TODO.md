## 跑马灯上位机程序 Spec TODO（Socket 编程版，学生项目简化）

### 1. 项目初始化

- [ ] 创建 Go 项目文件结构：`main.go`、`modbus.go`、`ui.go`、`config.go`
- [ ] **引入库：**
  - `fyne.io/fyne/v2`（GUI 框架）
  - `encoding/json`（配置文件读写）
  - `net`（TCP Socket 编程）
  - `time`（延时与定时器）
  - `bytes`（处理字节数据）
  - `encoding/binary`（字节转整数）
  - `fmt`（调试输出）
- [ ] 创建配置文件夹，保存 IP、端口、速度延时等参数
  - 配置文件格式：
    ```json
    {
      "ip": "192.168.0.10",
      "port": 502,
      "unitId": 1,
      "speedDelays": [1000, 500, 200],
      "pollIntervalMs": 200,
      "windowSize": [800, 600],
      "windowPosition": [100, 100]
    }
    ```
  - 存储位置：在exe所在目录创建config文件夹，如：`..\config\config.json`
- [ ] 启动时加载配置，若不存在则生成默认配置

---

### 2. Socket 通信基础

- [ ] 使用 `net.Dial("tcp", "IP:Port")` 建立 TCP 连接
- [ ] 构造 **MBAP 头**：
  - 事务 ID（从 1 开始递增）
  - 协议 ID 固定 0
  - 长度字段（后续字节数）
  - Unit ID（从配置读取）
- [ ] 构造 **PDU**：
  - 功能码（0x01、0x02、0x04、0x05、0x0F）
  - 短地址（逻辑地址 − 类型起始地址）
  - 数量或数据
- [ ] 发送请求并接收响应，按 Length 精确读取
- [ ] 处理连接超时与断线重连

---

### 3. 地址与功能码固定映射

- [ ] DQ：地址 1–14 → 功能码 0x01/0x05/0x0F
- [ ] DI：地址 10001–10014 → 功能码 0x02
- [ ] 温度：地址 30033 → 功能码 0x04
- [ ] 湿度：地址 30034 → 功能码 0x04
- [ ] 短地址计算函数：逻辑地址 − 类型起始地址（00001/10001/30001）

---

### 4. 跑马灯逻辑

- [ ] 定义输出点顺序（1–14）
- [ ] 第一次点击绿色按钮：启动并进入挡位 1
- [ ] 挡位循环切换（1→2→3→1），延时值：1000/500/200 ms
- [ ] 每次只点亮一个输出点，其余关闭
- [ ] 停止时清零所有输出点，挡位重置为空

---

### 5. 输入点与按钮控制

- [ ] 轮询 DI（10001–10014）
- [ ] 上升沿检测：绿色按钮启动/加档，红色按钮停止
- [ ] 所有 DI 状态实时显示

---

### 6. 温湿度读取与转换

- [ ] 定时读取 30033（温度）、30034（湿度）
- [ ] 按大端解析为十进制，再代入公式：
  - 温度 = (值 / 27648) × 120 − 40
  - 湿度 = (值 / 27648) × 100
- [ ] 保留 1 位小数，异常值标记"无效/故障"

---

### 7. 手动输出控制

- [ ] 停止状态下允许用户开关任意 DQ
- [ ] 写入时优先使用写多线圈（0x0F）
- [ ] 启动跑马灯时清除手动状态

---

### 8. GUI 界面

- [ ] 顶部：连接状态、运行/停止、挡位、延时、当前输出点
- [ ] 控制区：启动（绿）、停止（红）、速度切换（绿）
- [ ] IO 状态区：DQ(1–14) 指示灯、DI(10001–10014) 状态
- [ ] 温湿度显示区（含有效标识）
- [ ] 手动控制区（停止时可操作）
- [ ] 信息通知悬浮泡：温湿度异常、通信异常、跑马灯启停事件
- [ ] 布局使用 Fyne 的 `container.NewVBox` / `NewHBox` / `NewGrid` 等组合实现

---

### 9. 基本测试

- [ ] 测试连接与断线重连
- [ ] 测试跑马灯循环与速度切换
- [ ] 测试 DI 按钮触发与状态显示
- [ ] 测试温湿度读取与公式计算
- [ ] 测试手动控制输出