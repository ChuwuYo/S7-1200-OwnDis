# 跑马灯上位机程序开发文档（基于 S7-1200 + Modbus TCP）

## 1. 项目目标

在 PLC 程序保持不变的前提下，开发一套基于 Modbus TCP 协议的上位机程序，实现以下功能：

- 控制 PLC 数字输出点（DQ）实现跑马灯效果
- 支持启停控制（实体按钮 + 虚拟按钮）
- 支持延时调节（三挡速度，实体与虚拟按钮均可控制）
- 提供可视化界面，实时反馈所有输入输出点状态
- 跑马灯停止时可手动控制任意输出点的开关状态
- 实时读取并显示温度与湿度数据（模拟量）
- 用户配置保存（创建配置文件夹，保存与读取json）

## 2. PLC 已知信息

### 型号与通信

- PLC型号：Siemens S7-1200  
- 通信协议：Modbus TCP  
- 端口号：默认 502，允许用户自定义修改  
- IP地址：由用户输入并保存（支持配置）

### 地址映射规则（基于 S7-1200 与 ModScan 映射）

| 类型           | 范围                           | Modbus地址范围     | 功能码                            |
| ------------ | ---------------------------- | -------------- | ------------------------------ |
| 数字输出（DQ）     | Q0.0–Q1.5                    | 地址 1–14        | 01（读线圈）、05（写单线圈）、15（写多线圈）      |
| 数字输入（DI）     | I0.0–I0.1                    | 地址 10001–10002 | 02（读离散输入）                      |
| 输入寄存器（IW）    | IW64、IW66                    | 地址 30033、30034 | 04（读输入寄存器）                     |
| 保持寄存器（MW/DB） | MW100、MW102… 或 DB.XXX.AA[0]… | 地址 40001+      | 03（读保持寄存器）、06（写单寄存器）、16（写多寄存器） |

- 所有地址从 1 开始（非 0），符合 ModScan 工具默认行为

## 3. 跑马灯控制逻辑

### 输出点顺序

- 跑马灯输出点为 DQ 区域：Q0.0–Q0.7（地址 1–8） + Q1.0–Q1.5（地址 9–14）
- 按照地址顺序依次点亮，每次仅一个点为 ON，其余为 OFF
- 完成一圈后继续循环，直到接收到停止信号

### 启停与速度控制

#### 启停控制

- 使用绿色按钮启动跑马灯
- 使用红色按钮停止运行，清除所有输出点状态，速度挡位重置为初始状态

#### 速度控制（三挡）

- 速度由虚拟按钮（绿色）和实体按钮共同控制
- 每次点击绿色按钮或实体按钮（同一功能）切换速度挡位，循环切换：
  - 第一次点击：启动 + 速度挡位 1
  - 第二次点击：速度挡位 2
  - 第三次点击：速度挡位 3
  - 第四次点击：回到速度挡位 1
- 红色按钮停止后，速度挡位清空，回归初始状态

#### 延时值对应速度挡位（示例）

| 挡位  | 延时值（ms） |
| --- | ------- |
| 1   | 1000    |
| 2   | 500     |
| 3   | 200     |

## 4. 温湿度读取逻辑

### 数据来源

- 温度：IW64（Modbus地址 30033）
- 湿度：IW66（Modbus地址 30034）

### 数字量转换公式

- Siemens S7-1200 模拟量范围：0–27648
- 转换公式：  
  - 温度（℃） = `IW64 / 27648 * 120 - 40`（量程 -40~80）  
  - 湿度（%） = `IW66 / 27648 * 100`（量程 0~100）

### 显示精度

- 建议保留 1 位小数
- 异常值（如超出范围）可标记为“无效”或“传感器故障”

#### 5\. 上位机设计方案

### 技术栈

- **开发语言**：Go（Golang）
- **GUI 框架**：Fyne（原生跨平台，控件简洁，适合工业界面）
- **Modbus 库**：goburrow/modbus（支持 TCP，功能码齐全）
- **配置管理**：JSON 文件（保存 IP、端口、窗口状态等）
- **并发控制**：goroutine + time.Ticker（实现跑马灯延时与轮询）
- **部署方式**：单文件可执行程序，无需安装运行时

## 6. 保本逻辑设计（由上位机实现）

| 功能      | 说明                            |
| ------- | ----------------------------- |
| 启停状态保持  | 虚拟或实体按钮点击后，内部变量保持运行/停止状态      |
| 速度挡位保持  | 每次点击切换速度，循环 1→2→3→1…          |
| 输出状态保持  | 跑马灯运行时，仅当前点为 ON，其余为 OFF       |
| 边沿检测    | 实体按钮输入点需轮询状态，识别上升沿触发          |
| 停止后手动控制 | 停止状态下允许用户手动控制任意输出点的 ON/OFF 状态 |
| 温湿度读取   | 定时轮询 IW64/IW66，转换为实际值并显示      |

## 7. 控件与交互设计

### 控制按钮

- 启动（绿色）/ 停止（红色）
- 绿色按钮重复点击切换速度挡位（1→2→3→1…）
- 实体按钮与虚拟按钮功能一致，均可切换速度

### 输入点选择

- 启停按钮输入点（DI 地址）
- 所有输入点状态实时显示（是否按下）

### 状态显示

- 当前运行状态（运行/停止）
- 当前速度挡位（1/2/3）
- 当前延时值（ms）
- 当前输出点地址
- 所有输出点状态（ON/OFF）
- 所有输入点状态（是否按下）
- 当前温度（℃）
- 当前湿度（%）

### 手动控制区

- 跑马灯停止时，显示所有输出点的控制开关
- 用户可单独设置任意输出点为 ON 或 OFF

# 