# 跑马灯上位机程序开发文档（基于 S7-1200 + Modbus TCP，Socket 编程版）

## 1. 项目目标

- 控制 PLC 数字输出点（DQ）实现跑马灯效果
- 支持启停控制（实体按钮 + 虚拟按钮）
- 支持延时调节（三挡速度，实体与虚拟按钮均可控制）
- 提供可视化界面，实时反馈所有输入输出点状态
- 跑马灯停止时可手动控制任意输出点的开关状态
- 实时读取并显示温度与湿度数据（模拟量）
- 用户配置保存（创建配置文件夹，保存与读取 JSON）

---

## 2. PLC 与通信信息

### 型号与通信

- PLC 型号：Siemens S7-1200
- 通信协议：Modbus TCP
- 端口号：默认 502，允许用户自定义修改
- IP 地址：由用户输入并保存（支持配置）
- 通信实现：使用 TCP Socket 编程（`net.TCPConn`）直接构造/发送/接收 Modbus TCP 报文（MBAP + PDU）

### 地址映射规则（基于 S7-1200 与 ModScan 映射）

| 类型           | 范围                           | Modbus 地址范围                | 功能码                            |
| ------------ | ---------------------------- | -------------------------- | ------------------------------ |
| 数字输出（DQ）     | Q0.0–Q0.7、Q1.0–Q1.5                   | 地址 1–14                    | 01（读线圈）、05（写单线圈）、15（写多线圈）      |
| 数字输入（DI）     | I0.0–I0.7、I1.0–I1.5          | 地址 10001–10008、10009–10014 | 02（读离散输入）                      |
| 输入寄存器（IW）    | IW64、IW66                    | 地址 30033、30034             | 04（读输入寄存器）                     |
| 保持寄存器（MW/DB） | MW100、MW102… 或 DB.XXX.AA[0]… | 地址 40001+                  | 03（读保持寄存器）、06（写单寄存器）、16（写多寄存器） |

- 所有地址从 1 开始（非 0），符合 ModScan 默认行为
- **短地址（偏移量）计算规则：** 短地址 = 逻辑地址 − 类型起始地址
  - 线圈 00001 → 短地址 0
  - 离散输入 10001 → 短地址 0
  - 输入寄存器 30033 → 短地址 32

---

## 3. Modbus 报文示例（读取 I1.2）

- **目标：** 读取 I1.2（逻辑地址 10012，对应离散输入第 12 位）

- **请求报文：**
  
  ```
  01 00 00 00 00 06 01 02 00 00 00 64
  ```
  
  - 起始短地址 00 00（对应 10001）
  - 数量 00 64（读取 100 位，覆盖到 I1.x）

- **响应报文（I1.2 为亮）：**
  
  ```
  01 00 00 00 00 10 01 02 0D 00 04 00 00 00 00 00 00 00 00 00 00 00
  ```
  
  - 字节计数 0x0D（100 位需 13 字节）
  - 数据区对应 I1.2 的位为 1（示例中第 0x04 位置为 0x04）

- **响应报文（I1.2 为灭）：** 同结构，对应位置为 0x00

---

## 4. Modbus 报文示例（读取和控制 Q0.5）

- **目标：** 读取 Q0.5（逻辑地址 5，对应线圈第 5 位）

- **请求报文（读取 DQ 数据）：**
  
  ```
  01 00 00 00 00 06 01 01 00 00 00 64
  ```
  
  - 起始短地址 00 00（对应线圈地址 1）
  - 数量 00 64（读取 100 位，覆盖到 Q1.x）

- **响应报文（Q0.5 为亮）：**
  
  ```
  01 00 00 00 00 10 01 01 0D 20 00 00 00 00 00 00 00 00 00 00 00 00
  ```
  
  - 字节计数 0x0D（100 位需 13 字节）
  - 数据区对应 Q0.5 的位为 1（示例中第 0x20 位置为 0x20）

- **请求报文（控制 Q0.0 从 off 变为 on）：**
  
  ```
  02 00 00 00 00 06 01 05 00 00 FF 00
  ```
  
  - 请求标识 02 00
  - 协议标识 00 00
  - 长度字段 00 06
  - Unit ID 01
  - 功能码 05（写单线圈）
  - 输出地址 00 00（对应线圈地址 1，即 Q0.0）
  - 输出值 FF 00（ON 状态）

- **响应报文（成功写入）：**
  
  ```
  02 00 00 00 00 06 01 05 00 00 FF 00
  ```
  
  - 与请求报文相同，表示写入成功

---

## 4. 跑马灯控制逻辑

- 输出点顺序：Q0.0–Q0.7（地址 1–8） + Q1.0–Q1.5（地址 9–14）依次点亮
- 每次仅一个点为 ON，其余为 OFF
- 完成一圈后继续循环，直到停止
- **启停控制：**
  - 绿色按钮：第一次点击启动并进入挡位 1；后续点击循环 1→2→3→1
  - 红色按钮：停止运行，清除所有输出点状态，速度挡位重置为空
- **延时值示例：** 1挡 1000ms、2挡 500ms、3挡 200ms
- 跑马灯运行时禁止手动控制输出

---

## 5. 温湿度读取与转换

- 数据来源：IW64（30033，温度）、IW66（30034，湿度），功能码 0x04
- **字节序：** 大端（高字节在前，低字节在后）
- **解析流程：**
  1. 从 PLC 接收两个字节的十六进制值（例如 `3B 31`）
  2. 按大端合并为十进制（`0x3B31` → 15153）
  3. 将十进制值代入公式
- **公式：**
  - 温度（℃） = (值 / 27648) × 120 − 40
  - 湿度（%） = (값 / 27648) × 100
- 保留 1 位小数
- 异常值标记为"无效"或"传感器故障"

---

## 6. 上位机设计方案

- 开发语言：Go（Golang）
- GUI 框架：web UI
- 通信实现：Socket 编程（TCP）手工构造/解析 Modbus TCP 报文
- 配置管理：JSON 文件（保存 IP、端口、UnitID、速度挡位延时、轮询周期、窗口参数）
- 并发控制：goroutine + time.Ticker
- 部署方式：单文件可执行程序
- 项目文件结构：
  - `main.go`：程序入口
  - `modbus.go`：Modbus TCP通信实现
  - `ui.go`：用户界面实现
  - `config.go`：配置文件读写实现

---

## 7. 保持逻辑设计

- 启停状态保持
- 速度挡位保持
- 输出状态保持
- 边沿检测（仅识别上升沿）
- 停止后手动控制
- 温湿度定时读取与显示

---

## 8. 控件与交互设计

- 控制按钮：启动（绿）、停止（红）、速度切换（绿）
- 输入点选择：启停按钮绑定到 DI 地址；实时显示所有 DI（10001–10014）
- 状态显示：
  - 当前运行状态
  - 当前速度挡位
  - 当前延时值
  - 当前输出点地址
  - 所有输出点状态（ON/OFF）
  - 所有输入点状态（是否按下）
  - 当前温度（℃）
  - 当前湿度（%）
- 手动控制区：停止状态下允许操控所有输出点开关
- **信息通知悬浮泡：**
  - 触发条件：温湿度异常、通信异常、跑马灯启停事件
  - 样式：半透明背景、圆角矩形、图标+文本
  - 自动消失：3~5 秒淡出或点击关闭
  - 实现方式：Fyne 浮层或弹窗模拟悬浮效果